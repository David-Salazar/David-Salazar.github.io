<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.262">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="">
<meta name="dcterms.date" content="2020-07-08">

<title>David Salazar - BDA week 7: LOO and its diagnostics</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">David Salazar</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../archive.html">
 <span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/David-Salazar"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/DavidSalazarVir"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">BDA week 7: LOO and its diagnostics</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 8, 2020</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#what-is-our-metric-log-pointwise-predictive-density" id="toc-what-is-our-metric-log-pointwise-predictive-density" class="nav-link active" data-scroll-target="#what-is-our-metric-log-pointwise-predictive-density">What is our metric? Log pointwise predictive density</a></li>
  <li><a href="#approximating-the-loo-posterior" id="toc-approximating-the-loo-posterior" class="nav-link" data-scroll-target="#approximating-the-loo-posterior">Approximating the LOO posterior</a></li>
  <li><a href="#the-approximation-is-likely-to-fail" id="toc-the-approximation-is-likely-to-fail" class="nav-link" data-scroll-target="#the-approximation-is-likely-to-fail">The approximation is likely to fail</a></li>
  <li><a href="#correcting-the-approximation-with-psis" id="toc-correcting-the-approximation-with-psis" class="nav-link" data-scroll-target="#correcting-the-approximation-with-psis">Correcting the approximation with PSIS</a>
  <ul class="collapse">
  <li><a href="#its-about-the-diagnostics-we-made-along-the-way" id="toc-its-about-the-diagnostics-we-made-along-the-way" class="nav-link" data-scroll-target="#its-about-the-diagnostics-we-made-along-the-way">It’s about the diagnostics we made along the way</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>Once Stan’s implementation of HMC has run its magic, we finally have samples from the posterior distribution <span class="math inline">\(\pi (\theta | y))\)</span>. We can then run posterior predictive checks and hopefully our samples looks plausible under our posterior. Nevertheless, this is just an internal validation check: <strong>we expect more from our model</strong>. We expect it to hold under an external validation check: never seen observations, once predicted, should also look plausible under our posterior.</p>
<p><strong>Leave-One-Out (LOO) log pointwise predictive density</strong> is the preferred Bayesian way to do this. In this blogpost, I’ll explain how we can <strong>approximate</strong> this metric <em>without the need of refitting the model <span class="math inline">\(n\)</span> times</em> with <strong>LOO Pareto Smoothed Importance Sampling (PSIS)</strong>. Also, I’ll explain how PSIS diagnostics tells us, not unlike HMC, when the algorithm is a poor approximation. As a byproduct, we can also derive a metric to identify if there are influential observations that are driving the inference. Finally, I’ll simulate data to show how we can perform all this with real data.</p>
<p>All of this is based on this <a href="https://arxiv.org/abs/1507.04544">great paper</a> by Vehtari, Gelman and Gabry.</p>
<section id="what-is-our-metric-log-pointwise-predictive-density" class="level2">
<h2 class="anchored" data-anchor-id="what-is-our-metric-log-pointwise-predictive-density">What is our metric? Log pointwise predictive density</h2>
<p>Given an observation <span class="math inline">\(y_i\)</span>, we define our metric to evaluate how well we have predicted <span class="math inline">\(y_i\)</span> as its log likelihood according to our model. Given our uncertainty over the parameters, we integrate over our posterior distribution for our model. We call this the <strong>log pointwise predictive density (lpd)</strong>:</p>
<p><span class="math display">\[
lpd = \log \int \pi (y_i | \theta) \pi (\theta | y) d\theta
\]</span></p>
<p>The fundamental problem comes when we use <span class="math inline">\(y_i\)</span> to compute the full posterior <span class="math inline">\(\pi (\theta | y)\)</span>: we are performing an internal check, not an external validation. A solution is to use the resulting posterior without using the observation <span class="math inline">\(y_i\)</span> in the fitting. <strong>This is the Leave-One-Out (LOO) posterior</strong>: <span class="math inline">\(\pi(\theta, y_{-i})\)</span></p>
<p>The problem is that evaluating the LOO posterior is just as computationally expensive as fitting the model all over again. If we then want to use all our observations to perform the external validation check, this amounts to fitting the probability model <span class="math inline">\(n\)</span> times.</p>
</section>
<section id="approximating-the-loo-posterior" class="level2">
<h2 class="anchored" data-anchor-id="approximating-the-loo-posterior">Approximating the LOO posterior</h2>
<p>Not being able to compute from a distribution is an awfully familiar problem in Bayesian Statistics. Which in this case comes in handy. We can use <a href="https://david-salazar.github.io/2020/06/27/bayesian-data-analysis-week-4-importance-sampling/">Importance Sampling</a> to use <strong>the samples from the full posterior to approximate the LOO posterior</strong>. Thus, our Importance Weights for each sample <span class="math inline">\(s\)</span> from the posterior is the ratio of the densities.</p>
<p><span class="math display">\[
r_i^s = \frac{\pi (\theta^s | y_{-i})}{\pi(\theta^s|y_i)}
\]</span></p>
<p>If we correct, then, our original full posterior samples by these weights, we get equivalent samples from the LOO posterior. Thus, we can compute the <strong>log pointwise predictive density (lpd)</strong> that can track the out-of-sample performance of our model.</p>
</section>
<section id="the-approximation-is-likely-to-fail" class="level2">
<h2 class="anchored" data-anchor-id="the-approximation-is-likely-to-fail">The approximation is likely to fail</h2>
<p>Sadly, this approximation to the LOO posterior using the full posterior is likely to fail. Importance Sampling only works when all of the weights are roughly equal. When the weights are very small with a large probability, and very, very large with a small probability, Importance Sampling fails: our computations end up <em>effectively</em> using <strong>only the large weights samples</strong>, thus drastically reducing our <strong>effective number of samples from the LOO posterior</strong>. That is, Importance Sampling is likely to <strong>fail when the distribution of the weights is fat-tailed</strong>.</p>
<p>Sadly, this is very likely to happen with our approximation: the LOO posterior is likely to have a <em>larger variance and fatter tails</em> than the full posterior. Thus, samples from the tails of the full posterior will have large weights to compensate for this fact. Therefore, the distribution of importance weights is likely gonna be fat-tailed.</p>
</section>
<section id="correcting-the-approximation-with-psis" class="level2">
<h2 class="anchored" data-anchor-id="correcting-the-approximation-with-psis">Correcting the approximation with PSIS</h2>
<p>Vehtari, Gelman and Gabry correct the distribution of Importance Weights and thereby improve the approximation to the LOO posterior. First, they use Extreme Value Theory to fit the tail of the distribution with a Generalized Pareto Distribution with tail shape parameter <span class="math inline">\(k\)</span> (<span class="math inline">\(GPD(k)\)</span>).</p>
<p>Secondly, they replace the large weights with smoothed over versions of the weights according to expected order statistics of the fitted <span class="math inline">\(GPD(k)\)</span>. This in turn gives the name to the method: <strong>Pareto Smoothed Importance Sampling (PSIS)</strong> Thirdly, they truncate large weights at <span class="math inline">\(\dfrac{3}{4}\)</span> of the mean of the smoothed weights.</p>
<p>Therefore, we arrive at a new vector of importance weights <span class="math inline">\(w_i^s\)</span> which, in general, behaves better than the original importance weights <span class="math inline">\(r_i^s\)</span> and thus allow us to perform a better approximation of the LOO posterior.</p>
<section id="its-about-the-diagnostics-we-made-along-the-way" class="level3">
<h3 class="anchored" data-anchor-id="its-about-the-diagnostics-we-made-along-the-way">It’s about the diagnostics we made along the way</h3>
<p>The great thing about PSIS, besides creating better importance weights, it’s the diagnostics that it creates along the way. By fitting a <span class="math inline">\(GPD(k)\)</span>, the tail shape parameter becomes a diagnostic to assess the reliability of our approximation. When is Pareto Smoothed Importance Sampling (PSIS) a valid approximation to the LOO posterior?</p>
<p>The smoothing and the truncating can only do so much. If <span class="math inline">\(k &gt; 0.7\)</span>, the importance weights are probably too fat-tailed to begin with and PSIS-LOO will be a poor approximation the LOO posterior. Not only that, it is also a diagnostic that tells us about a fundamental disagreement bewteen the full posterior and the LOO posterior: that is, <strong>about observations that are highly influential in determining the posterior.</strong></p>
<p>Therefore, by performing PSIS-LOO, we also arrive at a diagnostic for highly influential observations that are driving our inference and are thus surprising observations to our model.</p>


</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div quarto-reuse="quarto-reuse" class="quarto-appendix-contents"><a rel="license" href="https://creativecommons.org/licenses/by/4.0/">https://creativecommons.org/licenses/by/4.0/</a></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>
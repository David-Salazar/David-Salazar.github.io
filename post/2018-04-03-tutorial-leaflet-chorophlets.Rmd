---
title: Tutorial Leaflet Chorophlets
author: David Salazar
date: '2018-04-03'
slug: tutorial-leaflet-chorophlets
categories:
  - tutorial
tags:
  - leaflet
---

# Leaflet 

`Leaflet` is javascript library. You can access it, like many other cool interactive libraries (i.e., `dygraphs`) thanks to the work of people in RStudio. Here, I'll layout a basic structure for plotting simple maps in leaflet and then how to advance them and plot chorophlets. 

Inspired by: 

* https://rstudio.github.io/leaflet/choropleths.html
* https://stackoverflow.com/questions/47571337/how-to-create-a-choropleth-on-a-leaflet-map-r


## Loading packages 

```{r}
library(tidyverse)
library(leaflet)
library(raster)
```

## Getting the polygons

A basic map will be one with the first level political divisions of a country drawn. To do so, we need a set of polygons for the whole country and the poilitical divisions. The easiest way to get these political divisions is with `raster::getData`.
Let's do so for Colombia

```{r}
getData("ISO3") %>% 
  filter(startsWith(NAME, "Colomb"))
```

```{r}
colombia <- getData(name = "GADM", country = "COL", level = 1)
class(colombia)
```

## Drawing with Leaflet

Now, let's draw them! A basic leaflet structure, simply change the data argument. 

```{r}
leaflet() %>% 
addProviderTiles("OpenStreetMap.Mapnik") %>%
setView(lng = -74.063, 4.62, 4) %>%
addPolygons(data = colombia,
            stroke = FALSE, smoothFactor = 0.2, fillOpacity = 0.3,
            highlight = highlightOptions(
    weight = 5,
    color = "#666",
    dashArray = "",
    fillOpacity = 0.7,
    bringToFront = TRUE),
    label = colombia$NAME_1,
labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "15px",
    direction = "auto"))
```

## Chorophlets

To make a chorophlet, we have to add another argument to the `leaflet::addPolygons()` function:

```{r}
tbl <- data.frame(place = unique(colombia$NAME_1),
                   value = sample.int(n = 10000, size = n_distinct(colombia$NAME_1), replace = TRUE))

mypal <- colorNumeric(palette = "viridis", domain = tbl$value, n = 5, reverse = TRUE)

labels <- sprintf(
  "<strong>%s</strong><br/>%g ",
  tbl$place, tbl$value
) %>% lapply(htmltools::HTML)

leaflet() %>% 
addProviderTiles("OpenStreetMap.Mapnik") %>%
setView(lng = -74.063, 4.62, 4) %>%
addPolygons(data = colombia,
            stroke = FALSE, smoothFactor = 0.2, fillOpacity = 0.3,
            highlight = highlightOptions(
    weight = 5,
    color = "#666",
    dashArray = "",
    fillOpacity = 0.7,
    bringToFront = TRUE),
    fillColor = ~mypal(tbl$value),
    label = labels,
labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "15px",
    direction = "auto")) %>%
addLegend(position = "bottomright", pal = mypal, values = tbl$value,
          title = "# of ",
          labFormat = labelFormat(prefix = "$"),
          opacity = 1)

```

Notice that there are multiple `color` functions. Use them wisely according to your need. 
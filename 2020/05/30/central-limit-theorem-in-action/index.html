<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Hugo 0.58.3" />


<title>Central Limit Theorem in Action - Dilettanting Data Science</title>
<meta property="og:title" content="Central Limit Theorem in Action - Dilettanting Data Science">



  








<link href='//cdn.bootcss.com/highlight.js/9.11.0/styles/github.min.css' rel='stylesheet' type='text/css' />



<link rel="stylesheet" href="/css/fonts.css" media="all">
<link rel="stylesheet" href="/css/main.css" media="all">



  </head>
  <body>
    <div class="wrapper">
      <header class="header">
        <nav class="nav">
  <a href="/" class="nav-logo">
    <img src="/images/turner.jpg"
         width="200"
         height="200"
         alt="Logo">
  </a>

  <ul class="nav-links">
    
    <li><a href="/about/">About</a></li>
    
    <li><a href="https://github.com/David-Salazar">GitHub</a></li>
    
    <li><a href="https://www.kaggle.com/davidsalazarv95">Kaggle</a></li>
    
    <li><a href="https://david-salazar.github.io/">Posts</a></li>
    
    <li><a href="https://twitter.com/DavidSalazarVir?lang=en">Twitter</a></li>
    
  </ul>
</nav>

      </header>


<main class="content" role="main">

  <article class="article">
    
    <span class="article-duration">29 min read</span>
    

    <h1 class="article-title">Central Limit Theorem in Action</h1>

    
    <span class="article-date">2020/05/30</span>
    
    

    <div class="article-content">
      


<p>I have recently been exploring Nassim Taleb’s latest <a href="https://www.researchers.one/media/documents/260-m-Technical%20Incerto%20Vol%201.pdf">technical book: Statistical Consequences of Fat Tails</a>. In it, we have seen how the Law of Large Numbers for different estimators simply does not work fast enough (in Extremistan) to be used in real life. For example, we have seen how the distribution of the <a href="2020-04-17-fat-vs-thin-does-lln-work.html">sample mean</a>, <a href="2020-04-27-spurious-pca-under-thick-tails.html">PCA</a>, <a href="2020-05-22-correlation-is-not-correlation.html">sample correlation</a> and <a href="2020-05-26-r-squared-and-fat-tails.html"><span class="math inline">\(R^2\)</span></a> turn into pure noise when we are dealing with fat-tails.</p>
<p>In this post, I’ll try to show <em>the same problem</em> for the Central Limit Theorem (CLT). That is, when dealing with fat-tailed random variables with finite variance, <strong>the CLT takes way too long to warrant its use</strong>. The pre-asymptotic’s behavior, where we live and analyze data, will shows us how different Mediocristan is from Extremistan.</p>
<div id="clt-refresher" class="section level1">
<h1>CLT Refresher</h1>
<p>You have <span class="math inline">\(n\)</span> independent and identically distributed random variables. That is: <span class="math inline">\(X_i\)</span> such that: <span class="math inline">\(E(X_i) = \mu\)</span> and <span class="math inline">\(Var(X_i) = \sigma^2 &lt; +\infty\)</span>. The CLT tells you that their sample average, <span class="math inline">\(\bar{X_n}\)</span>, as <span class="math inline">\(n \to \infty\)</span>, converges in distribution to a Gaussian:</p>
<p><span class="math display">\[ \sqrt{n}(\bar{X_n} - \mu)  \xrightarrow[]d{} N(0, \sigma^2) \]</span></p>
<p>Which is equivalent to say that the <span class="math inline">\(Z\)</span>-scores of the sample mean will approximate a standard normal distribution. That is:</p>
<p><span class="math display">\[ \dfrac{\bar{X_n} - \mu}{\sigma{\sqrt{n}}} \xrightarrow[]d{} N(0, 1) \]</span></p>
</div>
<div id="simulating-means" class="section level1">
<h1>Simulating Means</h1>
<p>Therefore, if we want to simulate this convergence, we have to evaluate the distribution of the sample mean at different sample sizes. Here’s the code I wrote:</p>
<pre class="r"><code>sample_mean &lt;- function(FUN, n) {
  samples &lt;- FUN(n)
  mean(samples)
}

distribution_sample_mean &lt;- function(FUN, n, montecarlo_n) {
  name &lt;- glue::glue(&quot;sample_{n}&quot;)
  rerun(montecarlo_n, sample_mean(FUN, n)) %&gt;% 
    map(data.frame) %&gt;% 
    bind_rows() %&gt;% 
    rename(!!quo_name(name) := &quot;.x..i..&quot;)
}

simulate_sample_means &lt;- function(FUN, montecarlo_n, sample_sizes) {
  map_dfc(sample_sizes, ~ distribution_sample_mean(FUN, .x, montecarlo_n)) %&gt;% 
  cbind(sims = 1:montecarlo_n) %&gt;% 
  pivot_longer(-sims, names_to = &quot;samples_sizes&quot;, values_to = &quot;value&quot;) %&gt;% 
  mutate(samples_sizes = str_extract(samples_sizes, &quot;\\d+&quot;),
         samples_sizes = as.numeric(samples_sizes))
}</code></pre>
</div>
<div id="the-fastest-clt-standard-uniform" class="section level1">
<h1>The fastest CLT: Standard Uniform</h1>
<p>For example, let’s evaluate the distribution of the sample mean for a Standard Uniform with <span class="math inline">\(n = 2, 5, 10, 20, 30, 50, 100, 1,000, 10,000\)</span>. We will do so by calculating the z-scores of the sample mean and comparing it to a normal distribution, both by comparing densities and with <span class="math inline">\(QQ\)</span>-plot:</p>
<pre class="r"><code>ns &lt;- c(2, 5, 10, 20, 30, 50, 100, 1000, 10000)

uniform &lt;- simulate_sample_means(runif, 3000, ns) %&gt;% 
  rename(uniform = value) %&gt;% 
  group_by(samples_sizes) %&gt;% 
  mutate(z = (uniform - 0.5)*sqrt(12*samples_sizes)) %&gt;% 
  ungroup() %&gt;% 
  mutate(samples_sizes = factor(samples_sizes, ordered = TRUE))

uniform %&gt;% 
  ggplot(aes(sample = z, color = samples_sizes)) +
  stat_qq(alpha = 0.4) +
  stat_qq_line(aes(group = NA)) +
  theme(legend.position = &quot;bottom&quot;)  +
  transition_states(samples_sizes) +
  enter_fade() +
  exit_shrink() +
  labs(subtitle = &quot;Sample size {closest_state}&quot;,
       title = &quot;Distribution of Sample Mean: Standard Uniform&quot;,
       caption = &quot;Theoretical distirbution is standard normal&quot;,
       y = &quot;Sample mean from Uniform&quot;) +
  view_follow()</code></pre>
<p><img src="/post/2020-05-30-central-limit-theorem-in-action_files/figure-html/unnamed-chunk-3-1.gif" /><!-- --></p>
<p>Now, for the densities:</p>
<pre class="r"><code>uniform %&gt;% 
  ggplot(aes(z, fill = samples_sizes)) +
  geom_density(aes(group = NA)) +
  transition_states(samples_sizes,
                    transition_length = 2,
    state_length = 1) +
  stat_function(fun = dnorm, aes(color = &#39;Normal&#39;),
                         args = list(mean = 0, sd = 1),
                inherit.aes = FALSE) +
  enter_fade() +
  exit_shrink() +
  labs(subtitle = &quot;Sample size {closest_state}&quot;,
       title = &quot;Distribution of Sample Mean: Standard Uniform&quot;) +
  view_follow() -&gt; uniform_dens</code></pre>
<pre><code>## Warning: `mapping` is not used by stat_function()</code></pre>
<pre class="r"><code>uniform_dens</code></pre>
<p><img src="/post/2020-05-30-central-limit-theorem-in-action_files/figure-html/unnamed-chunk-4-1.gif" /><!-- --></p>
<p>With <span class="math inline">\(n=5\)</span> we already have a distribution extremely similar to a normal. That is, for the Standard Uniform, the CLT is useful even we have very few samples. We can confirm this by looking at the moments of the sample mean:</p>
<pre class="r"><code>uniform %&gt;% 
  group_by(samples_sizes) %&gt;% 
  summarise(mean = mean(z),
            var = var(z),
            skew = mean(z^3),
            kurtosis = mean(z^4)) %&gt;% 
  gt::gt() %&gt;% 
  gt::fmt_number(vars(mean, var, skew, kurtosis))</code></pre>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#bhxxqqypnu .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#bhxxqqypnu .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#bhxxqqypnu .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#bhxxqqypnu .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#bhxxqqypnu .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#bhxxqqypnu .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#bhxxqqypnu .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#bhxxqqypnu .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#bhxxqqypnu .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#bhxxqqypnu .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#bhxxqqypnu .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#bhxxqqypnu .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#bhxxqqypnu .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#bhxxqqypnu .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#bhxxqqypnu .gt_from_md > :first-child {
  margin-top: 0;
}

#bhxxqqypnu .gt_from_md > :last-child {
  margin-bottom: 0;
}

#bhxxqqypnu .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#bhxxqqypnu .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#bhxxqqypnu .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#bhxxqqypnu .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#bhxxqqypnu .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#bhxxqqypnu .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#bhxxqqypnu .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#bhxxqqypnu .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#bhxxqqypnu .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#bhxxqqypnu .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#bhxxqqypnu .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#bhxxqqypnu .gt_left {
  text-align: left;
}

#bhxxqqypnu .gt_center {
  text-align: center;
}

#bhxxqqypnu .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#bhxxqqypnu .gt_font_normal {
  font-weight: normal;
}

#bhxxqqypnu .gt_font_bold {
  font-weight: bold;
}

#bhxxqqypnu .gt_font_italic {
  font-style: italic;
}

#bhxxqqypnu .gt_super {
  font-size: 65%;
}

#bhxxqqypnu .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="bhxxqqypnu" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">samples_sizes</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">mean</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">var</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">skew</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">kurtosis</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_right">0.01</td>
      <td class="gt_row gt_right">0.99</td>
      <td class="gt_row gt_right">0.02</td>
      <td class="gt_row gt_right">2.37</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">5</td>
      <td class="gt_row gt_right">0.01</td>
      <td class="gt_row gt_right">1.01</td>
      <td class="gt_row gt_right">0.06</td>
      <td class="gt_row gt_right">2.77</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">10</td>
      <td class="gt_row gt_right">&minus;0.01</td>
      <td class="gt_row gt_right">0.97</td>
      <td class="gt_row gt_right">&minus;0.06</td>
      <td class="gt_row gt_right">2.73</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">20</td>
      <td class="gt_row gt_right">0.01</td>
      <td class="gt_row gt_right">1.02</td>
      <td class="gt_row gt_right">0.01</td>
      <td class="gt_row gt_right">2.90</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">30</td>
      <td class="gt_row gt_right">&minus;0.00</td>
      <td class="gt_row gt_right">1.03</td>
      <td class="gt_row gt_right">&minus;0.02</td>
      <td class="gt_row gt_right">3.16</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">50</td>
      <td class="gt_row gt_right">&minus;0.01</td>
      <td class="gt_row gt_right">1.00</td>
      <td class="gt_row gt_right">&minus;0.01</td>
      <td class="gt_row gt_right">2.97</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">100</td>
      <td class="gt_row gt_right">&minus;0.02</td>
      <td class="gt_row gt_right">1.03</td>
      <td class="gt_row gt_right">&minus;0.06</td>
      <td class="gt_row gt_right">3.37</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">1000</td>
      <td class="gt_row gt_right">&minus;0.01</td>
      <td class="gt_row gt_right">1.02</td>
      <td class="gt_row gt_right">&minus;0.02</td>
      <td class="gt_row gt_right">3.16</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">10000</td>
      <td class="gt_row gt_right">&minus;0.03</td>
      <td class="gt_row gt_right">1.01</td>
      <td class="gt_row gt_right">&minus;0.04</td>
      <td class="gt_row gt_right">2.95</td>
    </tr>
  </tbody>
  
  
</table></div>
<p>Notice that, for higher moments, the LLN takes longer to be a valid approximation.</p>
</div>
<div id="semi-slow-convergence-the-exponential" class="section level1">
<h1>Semi-slow convergence: the exponential</h1>
<p>Now, let’s do the same for the exponential (<span class="math inline">\(\lambda = 1\)</span>). We calculate the <span class="math inline">\(Z\)</span>-scores and then plot the comparisons. Let’s check the <span class="math inline">\(QQ\)</span>-plot:</p>
<pre class="r"><code>exponential &lt;- simulate_sample_means(rexp, 3000, ns) %&gt;% 
  rename(exponential = value) %&gt;% 
  group_by(samples_sizes) %&gt;% 
  mutate(z = (exponential - 1)*sqrt(samples_sizes)) %&gt;% 
  ungroup() %&gt;% 
  mutate(samples_sizes = factor(samples_sizes, ordered = TRUE))

exponential %&gt;% 
  ggplot(aes(sample = z, color = samples_sizes)) +
  stat_qq(alpha = 0.4) +
  stat_qq_line(aes(group = NA)) +
  theme(legend.position = &quot;bottom&quot;)  +
  transition_states(samples_sizes) +
  enter_fade() +
  exit_shrink() +
  view_follow() +
  labs(subtitle = &quot;Sample size {closest_state}&quot;,
       title = &quot;Distribution of Sample Mean: Exponential&quot;,
       caption = &quot;Theoretical distirbution is standard normal&quot;,
       y = &quot;Sample mean from Exponential&quot;)</code></pre>
<p><img src="/post/2020-05-30-central-limit-theorem-in-action_files/figure-html/unnamed-chunk-6-1.gif" /><!-- --></p>
<p>Now, for the densities:</p>
<pre class="r"><code>exponential %&gt;% 
  ggplot(aes(z, fill = samples_sizes)) +
  geom_density(aes(group = NA)) +
  transition_states(samples_sizes,
                    transition_length = 2,
    state_length = 1) +
  stat_function(fun = dnorm, aes(color = &#39;Normal&#39;),
                         args = list(mean = 0, sd = 1),
                inherit.aes = FALSE) +
  enter_fade() +
  exit_shrink() +
  labs(subtitle = &quot;Sample size {closest_state}&quot;,
       title = &quot;Distribution of Sample Mean: Exponential&quot;,
       caption = &quot;Theoretical distirbution is standard normal&quot;,
       y = &quot;Sample mean from Exponential&quot;) +
  view_follow() -&gt; exponential_dens
exponential_dens</code></pre>
<p><img src="/post/2020-05-30-central-limit-theorem-in-action_files/figure-html/unnamed-chunk-7-1.gif" /><!-- --></p>
<p>In comparison to the Standard Uniform, the convergence is slower with the Exponential: only with 20 or more observations there is a semblance of normality. However, that is still a totally achievable sample size. That is, the use of CLT is warranted with relatively few samples when we are working with an Exponential. We can confirm this by looking at the sample moments:</p>
<pre class="r"><code>exponential %&gt;% 
  group_by(samples_sizes) %&gt;% 
  summarise(mean = mean(z),
            var = var(z),
            skew = mean(z^3),
            kurtosis = mean(z^4)) %&gt;% 
  gt::gt() %&gt;% 
  gt::fmt_number(vars(mean, var, skew, kurtosis))</code></pre>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#xdorwbpxct .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#xdorwbpxct .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#xdorwbpxct .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#xdorwbpxct .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#xdorwbpxct .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#xdorwbpxct .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#xdorwbpxct .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#xdorwbpxct .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#xdorwbpxct .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#xdorwbpxct .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#xdorwbpxct .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#xdorwbpxct .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#xdorwbpxct .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#xdorwbpxct .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#xdorwbpxct .gt_from_md > :first-child {
  margin-top: 0;
}

#xdorwbpxct .gt_from_md > :last-child {
  margin-bottom: 0;
}

#xdorwbpxct .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#xdorwbpxct .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#xdorwbpxct .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#xdorwbpxct .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#xdorwbpxct .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#xdorwbpxct .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#xdorwbpxct .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#xdorwbpxct .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#xdorwbpxct .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#xdorwbpxct .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#xdorwbpxct .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#xdorwbpxct .gt_left {
  text-align: left;
}

#xdorwbpxct .gt_center {
  text-align: center;
}

#xdorwbpxct .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#xdorwbpxct .gt_font_normal {
  font-weight: normal;
}

#xdorwbpxct .gt_font_bold {
  font-weight: bold;
}

#xdorwbpxct .gt_font_italic {
  font-style: italic;
}

#xdorwbpxct .gt_super {
  font-size: 65%;
}

#xdorwbpxct .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="xdorwbpxct" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">samples_sizes</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">mean</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">var</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">skew</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">kurtosis</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_right">&minus;0.02</td>
      <td class="gt_row gt_right">0.99</td>
      <td class="gt_row gt_right">1.30</td>
      <td class="gt_row gt_right">5.20</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">5</td>
      <td class="gt_row gt_right">0.01</td>
      <td class="gt_row gt_right">1.04</td>
      <td class="gt_row gt_right">1.05</td>
      <td class="gt_row gt_right">4.88</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">10</td>
      <td class="gt_row gt_right">0.03</td>
      <td class="gt_row gt_right">1.00</td>
      <td class="gt_row gt_right">0.65</td>
      <td class="gt_row gt_right">3.43</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">20</td>
      <td class="gt_row gt_right">&minus;0.01</td>
      <td class="gt_row gt_right">0.99</td>
      <td class="gt_row gt_right">0.42</td>
      <td class="gt_row gt_right">3.25</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">30</td>
      <td class="gt_row gt_right">&minus;0.00</td>
      <td class="gt_row gt_right">0.99</td>
      <td class="gt_row gt_right">0.35</td>
      <td class="gt_row gt_right">3.17</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">50</td>
      <td class="gt_row gt_right">0.01</td>
      <td class="gt_row gt_right">0.99</td>
      <td class="gt_row gt_right">0.36</td>
      <td class="gt_row gt_right">3.12</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">100</td>
      <td class="gt_row gt_right">&minus;0.02</td>
      <td class="gt_row gt_right">1.02</td>
      <td class="gt_row gt_right">0.21</td>
      <td class="gt_row gt_right">3.24</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">1000</td>
      <td class="gt_row gt_right">0.01</td>
      <td class="gt_row gt_right">0.98</td>
      <td class="gt_row gt_right">0.03</td>
      <td class="gt_row gt_right">3.06</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">10000</td>
      <td class="gt_row gt_right">0.01</td>
      <td class="gt_row gt_right">1.02</td>
      <td class="gt_row gt_right">0.03</td>
      <td class="gt_row gt_right">2.91</td>
    </tr>
  </tbody>
  
  
</table></div>
<p>Again, <strong>notice that, for higher moments, the LLN takes longer to be a valid approximation</strong>.</p>
</div>
<div id="leaving-fast-convergence-behind-log-normal" class="section level1">
<h1>Leaving fast Convergence behind: Log Normal</h1>
<p>With the lognormal, things start getting interesting. For a lognormal from an underlying standard normal, we need lots of observations to “see” the CLT. Let’s check the QQ-plot:</p>
<pre class="r"><code>lognormal &lt;- simulate_sample_means(rlnorm, 3000, ns) %&gt;% 
  rename(lognormal = value) %&gt;% 
  group_by(samples_sizes) %&gt;% 
  mutate(z = (lognormal - exp(1/2) )/sqrt(( ( exp(1) - 1) * exp(1) ) / samples_sizes ) ) %&gt;% 
  ungroup() %&gt;% 
  mutate(samples_sizes = factor(samples_sizes, ordered = TRUE))

lognormal %&gt;% 
  ggplot(aes(sample = z, color = samples_sizes)) +
  stat_qq(alpha = 0.4) +
  stat_qq_line(aes(group = NA)) +
  theme(legend.position = &quot;bottom&quot;)  +
  transition_states(samples_sizes) +
  enter_fade() +
  exit_shrink() +
  view_follow() +
  labs(subtitle = &quot;Sample size {closest_state}&quot;,
       title = &quot;Distribution of Sample Mean: Lognormal&quot;,
       caption = &quot;Theoretical distirbution is standard normal&quot;,
       y = &quot;Sample mean from Lognormal&quot;)</code></pre>
<p><img src="/post/2020-05-30-central-limit-theorem-in-action_files/figure-html/unnamed-chunk-9-1.gif" /><!-- --></p>
<p>Now, for the densities:</p>
<pre class="r"><code>lognormal %&gt;% 
  ggplot(aes(z, fill = samples_sizes)) +
  geom_density(aes(group = NA)) +
  transition_states(samples_sizes,
                    transition_length = 2,
    state_length = 1) +
  stat_function(fun = dnorm, aes(color = &#39;Normal&#39;),
                         args = list(mean = 0, sd = 1),
                inherit.aes = FALSE) +
  enter_fade() +
  exit_shrink() +
  view_follow() +
  labs(subtitle = &quot;Sample size {closest_state}&quot;,
       title = &quot;Distribution of Sample Mean: Lognormal&quot;,
       caption = &quot;Theoretical distirbution is standard normal&quot;,
       y = &quot;Sample mean from Lognormal&quot;) -&gt; lognormal_dens
lognormal_dens</code></pre>
<p><img src="/post/2020-05-30-central-limit-theorem-in-action_files/figure-html/unnamed-chunk-10-1.gif" /><!-- --></p>
<p>With the log-normal, the distribution does not look normal for any of the sample sizes. <strong>It takes a long-time for the distribution of the sample mean to lose its skeweness and it will take even longer for it to have the kurtosis of a standard normal</strong>:</p>
<pre class="r"><code>lognormal %&gt;% 
  group_by(samples_sizes) %&gt;% 
  summarise(mean = mean(z),
            var = var(z),
            skew = mean(z^3),
            kurtosis = mean(z^4)) %&gt;% 
  gt::gt() %&gt;% 
  gt::fmt_number(vars(mean, var, skew, kurtosis))</code></pre>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#gdarrehdno .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#gdarrehdno .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#gdarrehdno .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#gdarrehdno .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#gdarrehdno .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#gdarrehdno .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#gdarrehdno .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#gdarrehdno .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#gdarrehdno .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#gdarrehdno .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#gdarrehdno .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#gdarrehdno .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#gdarrehdno .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#gdarrehdno .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#gdarrehdno .gt_from_md > :first-child {
  margin-top: 0;
}

#gdarrehdno .gt_from_md > :last-child {
  margin-bottom: 0;
}

#gdarrehdno .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#gdarrehdno .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#gdarrehdno .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#gdarrehdno .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#gdarrehdno .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#gdarrehdno .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#gdarrehdno .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#gdarrehdno .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#gdarrehdno .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#gdarrehdno .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#gdarrehdno .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#gdarrehdno .gt_left {
  text-align: left;
}

#gdarrehdno .gt_center {
  text-align: center;
}

#gdarrehdno .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#gdarrehdno .gt_font_normal {
  font-weight: normal;
}

#gdarrehdno .gt_font_bold {
  font-weight: bold;
}

#gdarrehdno .gt_font_italic {
  font-style: italic;
}

#gdarrehdno .gt_super {
  font-size: 65%;
}

#gdarrehdno .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="gdarrehdno" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">samples_sizes</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">mean</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">var</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">skew</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">kurtosis</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_right">&minus;0.03</td>
      <td class="gt_row gt_right">0.88</td>
      <td class="gt_row gt_right">2.70</td>
      <td class="gt_row gt_right">16.19</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">5</td>
      <td class="gt_row gt_right">&minus;0.00</td>
      <td class="gt_row gt_right">0.96</td>
      <td class="gt_row gt_right">2.12</td>
      <td class="gt_row gt_right">12.57</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">10</td>
      <td class="gt_row gt_right">0.01</td>
      <td class="gt_row gt_right">1.10</td>
      <td class="gt_row gt_right">2.69</td>
      <td class="gt_row gt_right">18.36</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">20</td>
      <td class="gt_row gt_right">&minus;0.04</td>
      <td class="gt_row gt_right">0.97</td>
      <td class="gt_row gt_right">1.06</td>
      <td class="gt_row gt_right">5.84</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">30</td>
      <td class="gt_row gt_right">&minus;0.03</td>
      <td class="gt_row gt_right">0.94</td>
      <td class="gt_row gt_right">0.78</td>
      <td class="gt_row gt_right">4.01</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">50</td>
      <td class="gt_row gt_right">0.01</td>
      <td class="gt_row gt_right">1.05</td>
      <td class="gt_row gt_right">0.97</td>
      <td class="gt_row gt_right">4.93</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">100</td>
      <td class="gt_row gt_right">0.01</td>
      <td class="gt_row gt_right">0.92</td>
      <td class="gt_row gt_right">0.43</td>
      <td class="gt_row gt_right">2.94</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">1000</td>
      <td class="gt_row gt_right">0.02</td>
      <td class="gt_row gt_right">1.02</td>
      <td class="gt_row gt_right">0.27</td>
      <td class="gt_row gt_right">3.39</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">10000</td>
      <td class="gt_row gt_right">0.02</td>
      <td class="gt_row gt_right">1.00</td>
      <td class="gt_row gt_right">0.11</td>
      <td class="gt_row gt_right">3.15</td>
    </tr>
  </tbody>
  
  
</table></div>
<p>Again, <strong>notice that, for higher moments, the LLN takes longer to be a valid approximation</strong>.</p>
<div id="worsening-the-problem" class="section level2">
<h2>Worsening the problem</h2>
<p>We can check how this problems exacerbate once we increase the variance of the underlying normal. For example, here it is a small change where <span class="math inline">\(sigma = 2\)</span> for the underlying normal.</p>
<pre class="r"><code>lognormal_large &lt;- simulate_sample_means(function(x) rlnorm(n = x, sdlog = 2), 3000, ns) %&gt;% 
  rename(lognormal = value) %&gt;% 
  group_by(samples_sizes) %&gt;% 
  mutate(z = (lognormal - exp(4/2) )/sqrt(( ( exp(4) - 1) * exp(4) ) / samples_sizes ) ) %&gt;% 
  ungroup() %&gt;% 
  mutate(samples_sizes = factor(samples_sizes, ordered = TRUE))

lognormal_large %&gt;% 
  ggplot(aes(z, fill = samples_sizes)) +
  geom_density(aes(group = NA)) +
  transition_states(samples_sizes) +
  stat_function(fun = dnorm, aes(color = &#39;Normal&#39;),
                         args = list(mean = 0, sd = 1),
                inherit.aes = FALSE) +
  enter_fade() +
  exit_shrink() +
  view_follow() +
  labs(subtitle = &quot;Sample size {closest_state}&quot;,
       title = &quot;Distribution of Sample Mean: Lognormal&quot;,
       caption = &quot;Theoretical distirbution is standard normal&quot;,
       y = &quot;Sample mean from Lognormal&quot;)</code></pre>
<pre><code>## Warning: `mapping` is not used by stat_function()</code></pre>
<p><img src="/post/2020-05-30-central-limit-theorem-in-action_files/figure-html/unnamed-chunk-12-1.gif" /><!-- --></p>
<p>Indeed, now the sample mean’s distribution has a much longer right tail. That is, the skewness and kurtosis problems persists even at very large sample sizes.</p>
<pre class="r"><code>lognormal_large %&gt;% 
  group_by(samples_sizes) %&gt;% 
  summarise(mean = mean(z),
            var = var(z),
            skew = mean(z^3),
            kurtosis = mean(z^4)) %&gt;% 
  gt::gt() %&gt;% 
  gt::fmt_number(vars(mean, var, skew, kurtosis))</code></pre>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#oskynfibso .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#oskynfibso .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#oskynfibso .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#oskynfibso .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#oskynfibso .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#oskynfibso .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#oskynfibso .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#oskynfibso .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#oskynfibso .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#oskynfibso .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#oskynfibso .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#oskynfibso .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#oskynfibso .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#oskynfibso .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#oskynfibso .gt_from_md > :first-child {
  margin-top: 0;
}

#oskynfibso .gt_from_md > :last-child {
  margin-bottom: 0;
}

#oskynfibso .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#oskynfibso .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#oskynfibso .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#oskynfibso .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#oskynfibso .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#oskynfibso .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#oskynfibso .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#oskynfibso .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#oskynfibso .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#oskynfibso .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#oskynfibso .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#oskynfibso .gt_left {
  text-align: left;
}

#oskynfibso .gt_center {
  text-align: center;
}

#oskynfibso .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#oskynfibso .gt_font_normal {
  font-weight: normal;
}

#oskynfibso .gt_font_bold {
  font-weight: bold;
}

#oskynfibso .gt_font_italic {
  font-style: italic;
}

#oskynfibso .gt_super {
  font-size: 65%;
}

#oskynfibso .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="oskynfibso" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">samples_sizes</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">mean</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">var</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">skew</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">kurtosis</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_right">&minus;0.00</td>
      <td class="gt_row gt_right">0.56</td>
      <td class="gt_row gt_right">5.85</td>
      <td class="gt_row gt_right">80.45</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">5</td>
      <td class="gt_row gt_right">&minus;0.00</td>
      <td class="gt_row gt_right">0.81</td>
      <td class="gt_row gt_right">12.96</td>
      <td class="gt_row gt_right">296.29</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">10</td>
      <td class="gt_row gt_right">0.04</td>
      <td class="gt_row gt_right">1.73</td>
      <td class="gt_row gt_right">52.95</td>
      <td class="gt_row gt_right">2,398.74</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">20</td>
      <td class="gt_row gt_right">&minus;0.03</td>
      <td class="gt_row gt_right">0.65</td>
      <td class="gt_row gt_right">6.83</td>
      <td class="gt_row gt_right">137.13</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">30</td>
      <td class="gt_row gt_right">0.03</td>
      <td class="gt_row gt_right">1.18</td>
      <td class="gt_row gt_right">20.64</td>
      <td class="gt_row gt_right">609.30</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">50</td>
      <td class="gt_row gt_right">&minus;0.02</td>
      <td class="gt_row gt_right">0.61</td>
      <td class="gt_row gt_right">2.62</td>
      <td class="gt_row gt_right">22.20</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">100</td>
      <td class="gt_row gt_right">&minus;0.01</td>
      <td class="gt_row gt_right">0.72</td>
      <td class="gt_row gt_right">3.49</td>
      <td class="gt_row gt_right">38.18</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">1000</td>
      <td class="gt_row gt_right">0.03</td>
      <td class="gt_row gt_right">1.59</td>
      <td class="gt_row gt_right">31.74</td>
      <td class="gt_row gt_right">1,236.59</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">10000</td>
      <td class="gt_row gt_right">0.01</td>
      <td class="gt_row gt_right">0.86</td>
      <td class="gt_row gt_right">0.78</td>
      <td class="gt_row gt_right">4.35</td>
    </tr>
  </tbody>
  
  
</table></div>
<p>Why does this happen? Because we have increased the importance of the tail in our calculations. <strong>Every once in a while we will get an extreme event: in the sample mean, this event can be averaged out. Here, even the square of the extreme event can be averaged out. However, this extreme event, when taking its cube or even its quartic value, cannot be so easily averaged out</strong>. To do so, we would need many, many more samples than we currently have.</p>
</div>
</div>
<div id="convergence-before-the-sun-dies-pareto-alpha-2.1" class="section level1">
<h1>Convergence before the sun dies? Pareto (alpha = 2.1)</h1>
<p>We must remember that the CLT holds when the samples have finite variance. Therefore, we must pick a Pareto with a tail exponent larger than <span class="math inline">\(2\)</span> (If you need a refresher on the intuitive meaning of the tail exponent, check <a href="2020-05-19-understanding-the-tail-exponent.html">this post</a> ) In this case, we chose <span class="math inline">\(\alpha = 2.1\)</span>.</p>
<p>Let’s check the <span class="math inline">\(QQ\)</span>-plot:</p>
<pre class="r"><code>alpha &lt;- 2.1
rpareto &lt;- function(n) {
   (1/runif(n)^(1/alpha)) # inverse transform sampling
}

mean_pareto &lt;- alpha / (alpha-1)
var_pareto &lt;-  alpha / ((alpha-1)^2 * (alpha-2))

pareto &lt;- simulate_sample_means(rpareto, 3000, ns) %&gt;% 
  rename(pareto = value) %&gt;% 
  group_by(samples_sizes) %&gt;% 
  mutate(z = (pareto - mean_pareto )/sqrt( var_pareto / samples_sizes ) ) %&gt;% 
  ungroup() %&gt;% 
  mutate(samples_sizes = factor(samples_sizes, ordered = TRUE))

pareto %&gt;% 
  ggplot(aes(sample = z, color = samples_sizes)) +
  stat_qq(alpha = 0.4) +
  stat_qq_line(aes(group = NA)) +
  theme(legend.position = &quot;bottom&quot;)  +
  transition_states(samples_sizes) +
  enter_fade() +
  exit_shrink() +
  view_follow() +
  labs(subtitle = &quot;Sample size {closest_state}&quot;,
       title = &quot;Distribution of Sample Mean: Pareto (alpha = 2.1)&quot;,
       caption = &quot;Theoretical distirbution is standard normal&quot;,
       y = &quot;Sample mean from Pareto&quot;)</code></pre>
<p><img src="/post/2020-05-30-central-limit-theorem-in-action_files/figure-html/unnamed-chunk-14-1.gif" /><!-- --></p>
<p>Now for the densities:</p>
<pre class="r"><code>pareto %&gt;% 
  ggplot(aes(z, fill = samples_sizes)) +
  geom_density(aes(group = NA)) +
  transition_states(samples_sizes,
                    transition_length = 2,
    state_length = 1) +
  stat_function(fun = dnorm, aes(color = &#39;Normal&#39;),
                         args = list(mean = 0, sd = 1),
                inherit.aes = FALSE) +
  enter_fade() +
  exit_shrink() +
  view_follow() +
  labs(subtitle = &quot;Sample size {closest_state}&quot;,
       title = &quot;Distribution of Sample Mean: Pareto (alpha = 2.1)&quot;,
       caption = &quot;Theoretical distirbution is standard normal&quot;,
       y = &quot;Sample mean from Pareto&quot;) -&gt; pareto_densities
pareto_densities</code></pre>
<p><img src="/post/2020-05-30-central-limit-theorem-in-action_files/figure-html/unnamed-chunk-15-1.gif" /><!-- --></p>
<p>As it can be seen from the plot above, the distribution of a Pareto’s sample mean is very far from a normal, even with 10k in each sample. For one, its right-tail is very long. Also, the sample variance seems way too small. That is, although the first moment converges, the second does not: this is expected, specially with fat tails: <strong><a href="2020-04-17-fat-vs-thin-does-lln-work.html">the LLN works way too slowly</a></strong>. Notice, however, that it doesn’t make much sense to calculate the sample skewness nor kurtosis: their theoretical counterparts do not exist for the underlying random variable and neither exist for its sample mean estimator.</p>
<pre class="r"><code>pareto %&gt;% 
  group_by(samples_sizes) %&gt;% 
  summarise(mean = mean(z),
            var = var(z)) %&gt;% 
  gt::gt() %&gt;% 
  gt::fmt_number(vars(mean, var))</code></pre>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#txomcswlce .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#txomcswlce .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#txomcswlce .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#txomcswlce .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#txomcswlce .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#txomcswlce .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#txomcswlce .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#txomcswlce .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#txomcswlce .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#txomcswlce .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#txomcswlce .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#txomcswlce .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#txomcswlce .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#txomcswlce .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#txomcswlce .gt_from_md > :first-child {
  margin-top: 0;
}

#txomcswlce .gt_from_md > :last-child {
  margin-bottom: 0;
}

#txomcswlce .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#txomcswlce .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#txomcswlce .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#txomcswlce .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#txomcswlce .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#txomcswlce .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#txomcswlce .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#txomcswlce .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#txomcswlce .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#txomcswlce .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#txomcswlce .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#txomcswlce .gt_left {
  text-align: left;
}

#txomcswlce .gt_center {
  text-align: center;
}

#txomcswlce .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#txomcswlce .gt_font_normal {
  font-weight: normal;
}

#txomcswlce .gt_font_bold {
  font-weight: bold;
}

#txomcswlce .gt_font_italic {
  font-style: italic;
}

#txomcswlce .gt_super {
  font-size: 65%;
}

#txomcswlce .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="txomcswlce" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">samples_sizes</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">mean</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">var</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_right">&minus;0.00</td>
      <td class="gt_row gt_right">0.20</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">5</td>
      <td class="gt_row gt_right">&minus;0.01</td>
      <td class="gt_row gt_right">0.21</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">10</td>
      <td class="gt_row gt_right">&minus;0.02</td>
      <td class="gt_row gt_right">0.26</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">20</td>
      <td class="gt_row gt_right">&minus;0.01</td>
      <td class="gt_row gt_right">0.29</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">30</td>
      <td class="gt_row gt_right">&minus;0.00</td>
      <td class="gt_row gt_right">0.47</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">50</td>
      <td class="gt_row gt_right">0.01</td>
      <td class="gt_row gt_right">0.43</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">100</td>
      <td class="gt_row gt_right">&minus;0.00</td>
      <td class="gt_row gt_right">0.33</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">1000</td>
      <td class="gt_row gt_right">0.01</td>
      <td class="gt_row gt_right">0.63</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">10000</td>
      <td class="gt_row gt_right">0.01</td>
      <td class="gt_row gt_right">0.82</td>
    </tr>
  </tbody>
  
  
</table></div>
<p>This is what fat-tails do to you. <strong>Even when their theoretical moments do exist, their very, very long pre-asymptotic behavior invalidate the use of both LLN and CLT for any reasonable amount of data</strong> The intuition for the under-estimation of the variance is simple: a large part of its theoretical variance comes from the tail; however, it takes a lot, a lot, of data to “see” the tail. Therefore, our sample won’t be able to measure correctly the variance because we don’t have enough data to see the tail.</p>
<div id="more-forgiving-pareto" class="section level2">
<h2>More forgiving Pareto</h2>
<p>Notice that as the Pareto’s tail exponent increases, these problems are mitigated. For example, let’s take a Pareto with <span class="math inline">\(\alpha = 4.1\)</span> such that both skewness and kurtosis exist:</p>
<pre class="r"><code>alpha &lt;- 4.1

mean_pareto &lt;- alpha / (alpha-1)
var_pareto &lt;-  alpha / ((alpha-1)^2 * (alpha-2))

pareto_forgiving &lt;- simulate_sample_means(rpareto, 3000, ns) %&gt;% 
  rename(pareto = value) %&gt;% 
  group_by(samples_sizes) %&gt;% 
  mutate(z = (pareto - mean_pareto )/sqrt( var_pareto / samples_sizes ) ) %&gt;% 
  ungroup() %&gt;% 
  mutate(samples_sizes = factor(samples_sizes, ordered = TRUE))

pareto_forgiving %&gt;% 
  ggplot(aes(z, fill = samples_sizes)) +
  geom_density(aes(group = NA)) +
  transition_states(samples_sizes) +
  stat_function(fun = dnorm, aes(color = &#39;Normal&#39;),
                         args = list(mean = 0, sd = 1),
                inherit.aes = FALSE) +
  enter_fade() +
  exit_shrink() +
  view_follow() +
  labs(subtitle = &quot;Sample size {closest_state}&quot;,
       title = &quot;Distribution of Sample Mean: Pareto (alpha = 4.1)&quot;,
       caption = &quot;Theoretical distirbution is standard normal&quot;,
       y = &quot;Sample mean from Pareto&quot;)</code></pre>
<p><img src="/post/2020-05-30-central-limit-theorem-in-action_files/figure-html/unnamed-chunk-17-1.gif" /><!-- --></p>
<p>As it can be seen, the problems with the tail diminish as we increase the tail exponent. We can also check the convergence of higher moments:</p>
<pre class="r"><code>pareto_forgiving %&gt;% 
  group_by(samples_sizes) %&gt;% 
  summarise(mean = mean(z),
            var = var(z),
            skewness = mean(z^3),
            kurtosis = mean(z^4)) %&gt;% 
  gt::gt() %&gt;% 
  gt::fmt_number(vars(mean, var, skewness, kurtosis))</code></pre>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#jfmyyeopss .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#jfmyyeopss .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#jfmyyeopss .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#jfmyyeopss .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#jfmyyeopss .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#jfmyyeopss .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#jfmyyeopss .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#jfmyyeopss .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#jfmyyeopss .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#jfmyyeopss .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#jfmyyeopss .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#jfmyyeopss .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#jfmyyeopss .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#jfmyyeopss .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#jfmyyeopss .gt_from_md > :first-child {
  margin-top: 0;
}

#jfmyyeopss .gt_from_md > :last-child {
  margin-bottom: 0;
}

#jfmyyeopss .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#jfmyyeopss .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#jfmyyeopss .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#jfmyyeopss .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#jfmyyeopss .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#jfmyyeopss .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#jfmyyeopss .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#jfmyyeopss .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#jfmyyeopss .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#jfmyyeopss .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#jfmyyeopss .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#jfmyyeopss .gt_left {
  text-align: left;
}

#jfmyyeopss .gt_center {
  text-align: center;
}

#jfmyyeopss .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#jfmyyeopss .gt_font_normal {
  font-weight: normal;
}

#jfmyyeopss .gt_font_bold {
  font-weight: bold;
}

#jfmyyeopss .gt_font_italic {
  font-style: italic;
}

#jfmyyeopss .gt_super {
  font-size: 65%;
}

#jfmyyeopss .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="jfmyyeopss" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table">
  
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">samples_sizes</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">mean</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">var</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">skewness</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_right" rowspan="1" colspan="1">kurtosis</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_right">0.01</td>
      <td class="gt_row gt_right">0.97</td>
      <td class="gt_row gt_right">3.26</td>
      <td class="gt_row gt_right">23.69</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">5</td>
      <td class="gt_row gt_right">&minus;0.02</td>
      <td class="gt_row gt_right">0.88</td>
      <td class="gt_row gt_right">1.58</td>
      <td class="gt_row gt_right">8.07</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">10</td>
      <td class="gt_row gt_right">0.01</td>
      <td class="gt_row gt_right">0.93</td>
      <td class="gt_row gt_right">1.18</td>
      <td class="gt_row gt_right">5.27</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">20</td>
      <td class="gt_row gt_right">0.00</td>
      <td class="gt_row gt_right">0.95</td>
      <td class="gt_row gt_right">0.94</td>
      <td class="gt_row gt_right">4.28</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">30</td>
      <td class="gt_row gt_right">0.04</td>
      <td class="gt_row gt_right">1.04</td>
      <td class="gt_row gt_right">1.62</td>
      <td class="gt_row gt_right">11.86</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">50</td>
      <td class="gt_row gt_right">0.01</td>
      <td class="gt_row gt_right">0.97</td>
      <td class="gt_row gt_right">0.75</td>
      <td class="gt_row gt_right">4.64</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">100</td>
      <td class="gt_row gt_right">0.00</td>
      <td class="gt_row gt_right">0.96</td>
      <td class="gt_row gt_right">0.53</td>
      <td class="gt_row gt_right">3.34</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">1000</td>
      <td class="gt_row gt_right">&minus;0.00</td>
      <td class="gt_row gt_right">0.96</td>
      <td class="gt_row gt_right">0.12</td>
      <td class="gt_row gt_right">2.75</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">10000</td>
      <td class="gt_row gt_right">0.00</td>
      <td class="gt_row gt_right">1.00</td>
      <td class="gt_row gt_right">&minus;0.05</td>
      <td class="gt_row gt_right">3.06</td>
    </tr>
  </tbody>
  
  
</table></div>
</div>
</div>
<div id="conclusion" class="section level1">
<h1>Conclusion</h1>
<p>In theory, the CLT is a valid approximation for the distribution of the sample mean: fat-tails (with finite variance) included. <em>However, the CLT only tells us the final destination of the convergence: it does not say anything regarding how fast this convergence will be.</em> <strong>As our Monte-Carlo experiments have shown, this convergence can be extremely slow: so slow, that the use of the CLT as a valid approximation may not be warranted at all for our usual samples sizes.</strong></p>
</div>

    </div>
  

  
<section id="comments">
  <div id="disqus_thread"></div>
  <script>
  var disqus_config = function () {
  
  };
  (function() {
    var inIFrame = function() {
      var iframe = true;
      try { iframe = window.self !== window.top; } catch (e) {}
      return iframe;
    };
    if (inIFrame()) return;
    var d = document, s = d.createElement('script');
    s.src = '//https-david-salazar-github-io.disqus.com/embed.js'; s.async = true;
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</section>


  
  </article>

</main>

      <footer class="footer">
        <ul class="footer-links">
          <li>
            <a href="/index.xml" type="application/rss+xml" target="_blank">RSS feed</a>
          </li>
          <li>
            <a href="https://gohugo.io/" class="footer-links-kudos">Made with <img src="/images/hugo-logo.png" width="22" height="22"></a>
          </li>
        </ul>
      </footer>

    </div>
    



<script src="//cdn.bootcss.com/highlight.js/9.11.0/highlight.min.js"></script>



<script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/r.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/yaml.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/python.min.js"></script>
<script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>



    
<script src="/js/math-code.js"></script>
<script async src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>


    
  </body>
</html>


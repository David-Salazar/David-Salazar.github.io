{
  "hash": "13326cf3d5facad4452c488cd5c37d7b",
  "result": {
    "markdown": "---\ntitle: 'Causality: Regret? Look at Effect of Treatment on the Treated'\nauthor: ''\ndate: '2020-08-16'\nslug: causality-effect-of-treatment-on-the-treated\ncategories: []\ntags: []\naliases: \n  - ../../2020/08/16/causality-effect-of-treatment-on-the-treated/\n---\n\n\n\n\n## Why read this?\n\nRegret about our actions stems from a [**counterfactual question**](https://david-salazar.github.io/2020/08/10/causality-counterfactuals-clash-of-worlds/): *What if I had acted differently?*. Therefore, to answer such question, we need a more elaborate language than the one we need to answer prediction or intervention questions. Why? Because we need to compare **what happened** with *what would had happened* if we **had acted differently**. We need to compute the **Effect of Treatment on the Treated (ETT)**. \n\nTo compute the ETT, we need to formulate a Structural Causal Model and leverage the **invariant qualities** across the *observed world and the hypothetical* world: the unobserved background variables. Indeed, the definition of the Effect of Treatment on the Treated (ETT) is defined for a binary treatment thus:\n\n$$\nE[Y_1 - Y_0 | X = 1] \\\\\n= \\sum_u [P(y_1 | x_1, u) - P(y_1 | x_0, u)] P(u |x_1)\n$$\n\nOf course, we don't have access to the background variables. In this post, we will learn to answer two questions: **when is the ETT identifiable?** And if so, can we give an **estimator** for such counterfactual *in terms of non-experimental data*?\n\nWe will first study a binary treatment and answer both questions. Then, we will tackle the more general case of any treatment. \n\n## A Motivating binary example\n\nThe following example is taken from Pearl's (et alter) book [Causal Inference in Statistics: A primer](http://bayes.cs.ucla.edu/PRIMER/). \n\n> Imagine an average adolescent: Joe. He has started smoking ever since he began High School. Should he regret his decision? That is, given that he has started smoking, has he significantly increased his chances of suffering from lung cancer compared to his chances had he never begun in the first place?\n\nTherefore, what Joe cares about is the **Effect of Treatment on the Treated**: $E[Cancer_1 - Cancer_0 | Smoking = 1]$. If ETT > 0, having smoked has caused a higher chance of lung cancer for Joe compared to the hypothetical world where he had never smoked in the first place. How can we calculate the ETT?\n\n$$\n\\begin{aligned}\nE T T &=E\\left[Y_{x}-Y_{x^{\\prime}} \\mid X=x\\right] \\\\\n&=E[Y_x \\mid X=x]-E\\left[Y_{x^{\\prime}} \\mid X=x\\right]\n\\end{aligned}\n$$\n\nThe challenge, thus, is to estimate the counterfactual expression $E\\left[Y_{x^{\\prime}} \\mid X=x\\right]$\n\n### Expressing ETT in terms of observational data and experimental data\n\nOur treatment is binary. Therefore, let's begin by using the law of total probability thus to write $E[Y_x]$\n\n$$\nE\\left[Y_{x}\\right]=E\\left[Y_{x} \\mid X=x\\right] P(X=x)+E\\left[Y_{x} \\mid X=x^{\\prime}\\right] P\\left(X=x^{\\prime}\\right)\n$$\n\nWe will use the consistency axiom: $E[Y_x | X = x] = E[Y | X = x]$; that is, a counterfactual predicated on an actual observation is no counterfactual. \n\nTherefore, we can re-write the above expression thus:\n\n$$\nE\\left[Y_{x}\\right]=E[Y \\mid X=x] P(X=x)+E\\left[Y_{x} \\mid X=x^{\\prime}\\right] P\\left(X=x^{\\prime}\\right)\n$$\n\nIn the above expression there's only one term that cannot be computed using observational data, $E\\left[Y_{x} \\mid X=x^{\\prime}\\right]$: the same term that causes trouble in our ETT estimation. Let's solve for it:\n\n$$\nE\\left[Y_{x} \\mid X=x^{\\prime}\\right]=\\frac{E\\left[Y_{x'}\\right]-E[Y \\mid X=x] P(X=x)}{P\\left(X=x^{\\prime}\\right)} \\\\\nE\\left[Y_{x} \\mid X=x^{\\prime}\\right]=\\frac{E\\left[Y | do(X = X')\\right]-E[Y \\mid X=x] P(X=x)}{P\\left(X=x^{\\prime}\\right)}\n$$\n\nBy plugging-in this term, we can express our ETT with terms that can be computed with a mix of observational and experimental data.\n\n$$\n\\begin{aligned}\nE T T &=E\\left[Y_{x}-Y_{x^{\\prime}} \\mid X=x\\right] \\\\\n&=E[Y \\mid X=x]-E\\left[Y_{x^{\\prime}} \\mid X=x\\right] \\\\\n&=E[Y \\mid X=x]-\\frac{E\\left[Y \\mid d o\\left(X=x^{\\prime}\\right)\\right]-E\\left[Y \\mid X=x^{\\prime}\\right] P\\left(X=x^{\\prime}\\right)}{P(X=x)}\n\\end{aligned}\n$$\n\nTherefore, if the treatment is binary, whenever the causal effect of $X$ can be identified, the ETT can also be identified. \n\n### Going back to Joe\n\nLet's go back to our motivating example. We can express the ETT using the above derivation:\n\n$$\n\\begin{aligned}\nE T T &=E\\left[Y_{1}-Y_{0} \\mid X=1\\right] \\\\\n&=E[Y \\mid X=1]-E\\left[Y_{0} \\mid X=1\\right] \\\\\n&=E[Y \\mid X=1]-\\frac{E[Y \\mid d o(X=0)]-E[Y \\mid X=0] P(X=0)}{P(X=1)}\n\\end{aligned}\n$$\n\nThus, we can estimate the ETT with only observational data if we can estimate $E[Y \\mid d o(X=0)]$ with observational data. Given that we know that we cannot estimate causal effects without making causal assumptions, let's formulate ours. \n\nLet's say that our causal DAG for the effects of Smoking on Cancer is the following:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexample <- dagify(x ~ u,\n                  m ~ x,\n                  y ~ u + m,\n                  labels = c(\"x\" = \"Smoking\",\n                             \"y\" = \"Cancer\",\n                             \"m\" = \"Tar\",\n                             \"u\" = \"Genotype\"),\n                  latent = \"u\",\n                  exposure = \"x\",\n                  outcome = \"y\")\n```\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](2020-08-16-causality-effect-of-treatment-on-the-treated_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\nTherefore, we can use the [front-door formula](https://david-salazar.github.io/2020/07/30/causality-the-front-door-criterion/) to estimate the causal effect of smoking: $E\\left[Y \\mid d o\\left(X=x^{\\prime}\\right)\\right]$.\n\nSuppose, then, that we collect the following data:\n\n![](https://cdn.mathpix.com/snip/images/6n3SO6qiX30qj9G6jSntJnaSnlZfjaUZv2rdgmlqxbk.rendered.fullsize.png)\n\nThen, using the front-door criterion, the causal effect $E[Y \\mid d o(X=0)]$ is:\n\n$$\n\\begin{aligned}\nE[Y \\mid d o(X=0)]=& \\sum_{z} P(Z=z \\mid X=0) \\sum_{x^{\\prime}} P\\left(Y=1 \\mid X=x^{\\prime}, Z=z\\right) P\\left(X=x^{\\prime}\\right) \\\\\n=& P(Z=1 \\mid X=0)[P(Y=1 \\mid X=1, Z=1) P(X=1)\\\\\n&+P(Y=1 \\mid X=0, Z=1) P(X=0)] \\\\\n&+P(Z=0 \\mid X=0)[P(Y=1 \\mid X=1, Z=0) P(X=1)\\\\\n&+P(Y=1 \\mid X=0, Z=0) P(X=0)] \\\\\n=& 20 / 400 *[0.15 * 0.5+0.95 * 0.5]+380 / 400 *[0.1 * 0.5+0.9 * 0.5] \\\\\n=& 0.5025\n\\end{aligned}\n$$\n\nFinally, we can calculate the ETT for Joe:\n\n\\[\n\\begin{aligned}\nE T T &=E\\left[Y_{1}-Y_{0} \\mid X=1\\right] \\\\\n&=E[Y \\mid X=1]-E\\left[Y_{0} \\mid X=1\\right] \\\\\n&=E[Y \\mid X=1]-\\frac{E[Y \\mid d o(X=0)]-E[Y \\mid X=0] P(X=0)}{P(X=1)} \\\\\n&=0.15-\\frac{0.5025-0.9025 * 0.5}{0.5} \\\\\n&=0.0475>0\n\\end{aligned}\n\\]\n\nTherefore, given that $ETT>0$, **by smoking Joe has increased his chances of suffering from Cancer**. Thus, he *should* feel regret: the *causal effect* smoking has had **in his life** has been to increase his chances of suffering from cancer, relative to those chances in the hypothetical world where he never smoked in the first place.\n\n## The more general case\n\nLet's say that our treatment is discrete, but not binary. Is the Effect of Treatment on the Treated (ETT) identifiable? [Pearl and Shipster](https://arxiv.org/abs/1205.2615) have given an answer to this question using [**C-components**](https://david-salazar.github.io/2020/07/31/causality-testing-identifiability/)\n\n### Identifiability using C-components\n\nRemember, two variables are assigned to the same c-component iff *they are connected by a bi-directed path*. The c-components themselves induce a factorization of the joint probability distribution in terms of **c-factors**: post-intervention distribution of the variables in \nthe respective c-component under an intervention on all the other variables.\n\nJust as before the causal effect was identified when $X$ and its children are in different C-components (i.e., there's no bi-directed path between $X$ and its children that are also ancestors of $Y$), the *necessary counterfactual expression* to **compute the ETT**, $P(Y_x = y|x')$, **is identifiable if and only if** $X$ and its children are in different C-components. \n\nIndeed, whereas before (when we were trying to estimate the causal effect) we summed out $x$ from the *c-factor*, we now replace $x$ by $x'$ [from the c-factor and divide by $P(x')$]((https://david-salazar.github.io/2020/07/31/causality-testing-identifiability/)). Then, we take the decomposition induced by the c-factors and marginalize and condition on the appropriate variables to get the variable of interest. \n\nThat is, the same test is a sufficient test for causal effects identifiability and both a necessary and sufficient test for ETT identifiability.\n\n### Confirming our former result\n\nLet's take our former example of the causal model of Smoking on Cancer. This time, we will use bi-directed paths to show that there's an unobserved confounder:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexample <- dagify(x ~~ y,\n                  m ~ x,\n                  y ~ m)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntidy_dagitty(example, layout = \"nicely\", seed = 2) %>% \n  node_descendants(\"x\") %>% \n  mutate(linetype = if_else(direction == \"->\", \"solid\", \"dashed\")) %>% \n  ggplot(aes(x = x, y = y, xend = xend, yend = yend, edge_linetype = linetype, color = descendant)) +\n  geom_dag_edges(aes(end_cap = ggraph::circle(10, \"mm\"))) +\n  geom_dag_point() + \n  geom_dag_text(col = \"white\") +\n  labs(title = \"The ETT is identifiable!\",\n       subtitle = \"Because there's no bi-directed path between x and m\")\n```\n\n::: {.cell-output-display}\n![](2020-08-16-causality-effect-of-treatment-on-the-treated_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\nSince $X$ has no bi-directed path to its child $m$, the counterfactual query $P(Y_x = y | x')$ is identifiable. Thus, the ETT is identifiable; confirming what we have done until now. \n\nHowever, if it were not binary, we could derive an estimator for the ETT using the induced factorization by the c-components. First, we replace with $x'$ in the c-component where $x$ is:\n\n$$\nP(x, y | do(m)) = P(y|m, x') P(x')\n$$\n\nWhereas the other c-component is\n\n$$\nP(m| do(y, x)) = P(m| do(x)) = P(m|x)\n$$\n\nTherefore, the conditional distribution on $x'$ \n\nConditioning on $x'$ and marginalizing $m$:\n\n$$\nP(y_x | x') = (\\sum_z P(y| z, x') P(x') P(z | x))/(P(x'))\n$$\n\nThat is, we replace $x$ with $x'$ in the c-component where $x$ is, we condition on $x'$ by dividing the joint density and marginalize $m$. Thus, we derive the estimator for the ETT in this model by using the c-factors. \n\n### Not identifiable\n\nNow let's work with an example where the causal effect is identifiable, yet the **counterfactual query $P(Y_x = y | x')$ is not**. \n\n\n::: {.cell}\n\n```{.r .cell-code}\nexample_not <- dagify(s ~~ y,\n                      x ~~ s, \n                      x ~ z,\n                      z ~ s,\n                      y ~ x\n                      )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntidy_dagitty(example_not, layout = \"nicely\", seed = 2) %>% \n  mutate(linetype = if_else(direction == \"->\", \"solid\", \"dashed\")) %>% \n    ggplot(aes(x = x, y = y, xend = xend, yend = yend, edge_linetype = linetype)) +\n  geom_dag_edges(aes(end_cap = ggraph::circle(10, \"mm\"))) +\n  geom_dag_point() + \n  geom_dag_text(col = \"white\") +\n  labs(title = \"The ETT is not identifiable\",\n       subtitle = \"X is connected by a bi-directed path with S\")\n```\n\n::: {.cell-output-display}\n![](2020-08-16-causality-effect-of-treatment-on-the-treated_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n# Conclusions\n\nWe've seen how regret is logically defined in terms of the Effect of Treatment on the Treated (ETT). We've also realized what are the conditions for the ETT to be identifiable and how to derive an estimator for it in terms of observational data.\n\n\n\n\n",
    "supporting": [
      "2020-08-16-causality-effect-of-treatment-on-the-treated_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}